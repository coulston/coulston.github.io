<!DOCTYPE html>
<html lang="en">
<!----- http://getbootstrap.com/css/ ----->
    <head>
        <title>Microcomputer Architecture and Interfacing</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="EENG 383 - Microcomputer Architecture and Interfacing">
        <meta name="author" content="Chris Coulston">
        <link rel='stylesheet' type='text/css' href='//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css'>
        <script src='//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js'></script>
    </head>

<body>
        <div class = "container">
            <div class = "navbar navbar-inverse">
                <div class = "navbar-inner">
                    <a class = "brand" href="../../index.html">EENG 383</a>
                    <ul class = "nav">
                        <li><a href="../../index.html">Home</a></li>
                        <li><a href="./lab13.html">Lab 13</a></li>
                    </ul>
 		     <ul class="nav pull-right">
                        <li>&nbsp;
                    </ul>

                </div>
        </div>

<center><h1>EENG 383</h1>
Lab 13 - Ultrasonic Parking Assistant</center>

<h2>Requirements</h2>
Working in teams of two,
read through the following lab activity and perform all the actions
prescribed.  You do not need to document bullet items.  Make a
record of your response to numbered items and turn them in a single copy
as your teams "inLab" assignment in class on Friday.  Word process your
solutions.
Include the names of both team members at the top of your solutions.
Use complete English sentences when answering questions.  If the
answer to a question is a table or other piece of art (like an
oscilloscope trace or a figure), then include a sentence explaining the
piece of art.  Only include your answers to the questions, do not include
the questions or other inLab text unless it is absolutely needed.


<h2>Objective</h2>
The objective of this lab is to teach you how to use interrupt subsystem
to control and measure signals from a HC-SR04 Ultrasonic range finder. 
Also we will examine how to resolve update conflicts that arise when
you need to change the MCC configuration.

<h2>External Hardware</h2>
To answer the following questions you will need to consult the 
<a href="./HCSR04.pdf">HCSR04 - Ultra-Sonic Ranging Module HC-SR04 Technical Specification</a>.
The speed of sound has some relationship to the elevation at which it is
measured.  Within a reasonable degree of accuracy, the speed of sound 
in Golden Colorado is 334 m/s.  Use this value in your calculations.

<ol>
<li>Given a range of x centimeters from the ultrasonic sensor to an
object, determine the duration of the echo pulse generated by the ultrasonic
sensor in milliseconds.  Remember that the acoustic pulse emitted by the 
ultrasonic sensor must travel out to the object and then reflect back to the 
sensor.  The echo pulse is held high during the flight time (out and back)
of this acoustic pulse.  Use dimensional analysis and show your work for 
full credit.

<li>I've found that the ultrasonic sensor can work out to 500cm; the technical
docs for the ultrasonic range finder list 400cm as the maximum range.  I've
also experienced problems with ranges below 10cm; the technical documents
list a minimum range of 2cm - best of luck with that.  Determine 
the duration of the echo pulse (in milliseconds) for an object placed at
10cm and 500cm from the ultrasonic sensor.  Use dimensional
analysis and show your work for full credit.

<li>Assuming that we are measuring the duration of the echo pulse using
a 16-bit timer, what is the smallest prescaler that can be used to 
measure the duration of the echo pulse.

<li>Given an echo pulse of x milliseconds generated by the ultrasonic 
sensor, determine the range (in centimeters) from the object to the 
ultrasonic sensor.  Use dimensional analysis and show your work for 
full credit.

<li>Open the HC-SR04 - Ultra-Sonic Ranger technical documents linked
earlier in this lab. What is the minimum duration of the pulse
on the trigger input? 

</ol>

<h2>Internal Subsystem</h2>
Discuss capture subsystem, rising and falling edge.
Interrupt subsystem.

<ol start=6>
<li>Given an echo pulse of duration x timer counts with the timer 
configured with a 1:8 prescaler, find the distance in centimeters
to the object.  Use dimensional analysis for full credit.
Note, the constant relating timer counts to centimeters will be called the
<u>conversion factor</u>.
</li>

Let's say that you measured the duration of the echo pulse using a 
1:8 prescaled timer and stored the number of timer counts in a variable 
called <font face="courier">timerCounts</font>.  I want you to convert the 
timer counts into a distance (in centimeters) by multiplying by the
conversion factor determined in the previous problem.  We will use 0.008
as the approximation in the following discussion, but you should use the
true value determined in the previous problem.  To summarize I would write
the equivalent of the following line of code in your program:
<br>
<font face="courier">distanceInCm = 0.008 * timerCounts;</font>
<br>
However since we are not allowed to use floating point math on the PIC, we 
will need to find an alternative.<br><br>


The idea will be to multiply the conversion factor by 2<sup>16</sup>,
multiply the result with timerCounts and then divide by 2<sup>16</sup>.
In other words:
<br>
<font face="courier">distanceInCm = ((2<sup>16</sup>*0.008) * timerCounts)/2<sup>16</sup>;</font>
<br>

Since we are multiplying and then dividing by the same factor (2<sup>16</sup>),
the factors cancel leaving us with the same answer as if we had just
multiplied by 0.008.  However, the advantage is that the product
2<sup>16</sup>*0.008 = 524 (rounded to nearest integer) which is easy
to multiply by timerCounts using regular integer math.  Then the division
by 2<sup>16</sup> can be accomplished by shifting right by 16-bits using
the C shift operation.
<li>Write a C-code snippet to convert timerCounts into distance in
centimeters.
</ol>



<h2>Firmware Organization</h2>
Build a project using the following MCC configuration:

<ul>
<li>In the INTERNAL OSCILLATOR area of the System Module window
<ul>	<li>Oscillator Select:	Internal oscillator block
	<li>System Clock Select: FOSC
	<li>Internal Clock: 16MHz_HFINTOSC
	<li>Software PLL Enabled: Check
</ul>
The Current System clock should be 64MHz (4x PLL)

<li>In the Pin Manager: Grid [MCC] tab of the console window
click on the open lock in the Port C 4 column and in the output row.

<li>In the Project Resources area of the project window, click 
"Pin Module".  The editor window will change from the System Module to
Pin Module. Click on the Custom Name text box in the RC4 row and change 
the name to "TRIGGER_PIN".

<li>If selected, unselect Analog.

<li>In the Device Resources area of the project window, expand the EUSART
option.  Double click EUSART1.
<li>In the Device Resources area of the project window, expand the CCP
option.  Double click CCP4
<li>In the Device Resources area of the project window, expand the Timer
option.  Double click TMR1.
<li>In the Device Resources area of the project window, expand the Timer
option.  Double click TMR0.


<li>In the Project Resources area of the project window click on EUSART1.
<ul>	<li>Enable EUSART:	&check;
	<li>Enable Transmit:	&check;
	<li>Enable Wake-up:	&square;
	<li>Auto-Baud Detection:	&square;
	<li>Enable Address Detect:	&square;
	<li>Baud Rate:		9600
	<li>Transmission Bits:	8-bit
	<li>Reception Bits:	8-bit
	<li>Clock Polarity:	async_noninverted_sync_fallingedge
	<li>Enable Receive:		&check;
	<li>Enable EUSART Interuupts:	&square;
	<li>Redirect STDIO to USART	&check;
</ul>

<li>In the Project Resources area of the project window click on CCP4.
<ul>	<li>ECCP mode:			Capture
	<li>Capture Timer Select:	Timer1
	<li>Capture mode:		Every rising edge
	<li>Enable CCP interrupt:	&square;
</ul>

<li>In the Project Resources area of the project window click on TMR1.
<ul>	<li>Enable Timer:	&check;
	<li>Clock Source:	FOSC/4
	<li>Prescaler:		1:8
	<li>Enable Synchronization:	&check;
	<li>Timer Period:	32ms
</ul>

<li>In the Project Resources area of the project window, expand the 
Peripherals option if not already expanded, and click on TMR0.
<ul>	<li>Enable Timer:	&check;
	<li>Enable Prescaler:	&check;
	<li>Prescaler:		1:32
	<li>Timer mode:		16-bit
	<li>Clock Source:	FOSC/4
	<li>Enable Timer Interrupt:	&check;
	<li>Requested Period:	131ms
</ul>
</ul>

<li>Click on the "Generate" button in the Project Resources area of the
project manager window.  In the MCC Save Configuration File, keep the 
defaults and Save.  Anytime that you make a change to the configuration
you must re-generate the supporting files by clicking on the generate
button,

<li>Click on the Project tab in the project manager window,
expand the Source Files folder and double click main.c to open 
it in the editor window.

<li>Replace the contents of main.c with 
<a href="./code/inlab13.c">inlab13.c</a>,

<li>Compile and download the code to the PIC,

<li>Wire up the ultrasonic range finder to the PIC using 4 jumper wires
according to the splash screen instructions guide.  In order to provide
power (Vcc) to the range finder you will need to remove the power jumper
from JP1 and connect the jumper wire to the pin closest to the USB mini
connector.  It should look something like the following; this setup will 
enable you to move the range finder while keeping the development board still. 
Experiment with the range finder and terminal application by pointing 
the range finder at nearby vertical surfaces and observing the values 
returned by the program.  You may experience interference if your 
neighbors at the lab bench are also experimenting.
</ul>
<br><img src="./img/ultraSonic.jpg"><br><br>

Let's examine the structure of the firmware before moving on with this
lab.  In the Project area of the project window, expand the
Source File folder then expand the MCC Generated Files folder.
<ol start=8>

<li>At the start of main the function 
<font face="courier">SYSTEM_Initialize</font> is called.  
Open the MCC generated file mcc.c, and find this function.
What function in this function initializes the interrupt 
subsystem?

<li>Open the MCC generated file interrupt_manager.c, what function is
called when
Timer 0 is enabled (INTCONbits.TMR0IE equals 1) and 
Timer 0 has rolled over (INTCONbits.TMR0IF equals 1)?

<li>Open the MCC generated file tmr0.c and find this function.  This
function performs three main actions, list them out.

<li>At the top of your main.c program, you call
<font face="courier">TMR0_SetInterruptHandler(myTMR0ISR);</font>.
What is the relationship between this function call and the third
action taken inside the TMR0_ISR function?
</ol>


<h2>Firmware Experiments</h2>
You may want to print out the centimeter measuring tape at 
<a href="https://d3spv9lkjdky95.cloudfront.net/PrintableTapeMeasure.pdf">this</a> link.
Lay a 30 centimeter-long piece of tape down on the lab bench.  Mark
off 2 cm intervals along the length of the tape.  Place the ultrasonic
range finder transducer along the 0 cm mark.  You will be placing a
solid hard surface along the length of the tape so that the ultrasonic
acoustic pulses better reflect.  For the following experiment, place a 
solid surface about 20cm away from the front of the ultrasonic range
finder.  To measure the ultrasonic range finder signals with the oscilloscope,
grab the ultrasonic range finder near the bend in its connector.

<!---
as shown in the following image.
<br><img src="./img/ultraProbe.jpg"><br><br>
--->

Now configure your oscilloscope as follows.<br><br>

<table class="table table-striped table-bordered table-condensed">
<tr><td>Ch1 probe		<td>Ultrasonic range finder right-angle 
					header pin labeled "Trig"
<tr><td>Ch1 ground clip		<td>Dev board ground loop
<tr><td>Ch2 probe		<td>Ultrasonic range finder right-angle 
					header pin labeled "Echo"
<tr><td>Ch2 ground clip		<td>Clip to its own cable, out of the way
<tr><td>Horizontal (scale) 	<td>2.5 ms
<tr><td>Ch1 (scale) 		<td>2V
<tr><td>Ch2 (scale) 		<td>2V
<tr><td>Trigger mode		<td>Auto
<tr><td>Trigger source		<td>1
<tr><td>Trigger slope		<td>&uarr;
<tr><td>Trigger level		<td>1.5V
</table>

Make sure to:
<ul>	<li>Align Ch 1 on the second lowest reticule,
<ul>	<li>Align Ch 2 on the second lowest reticule on upper half,
	<li>Align the horizontal position at the second left-most reticule,
	<li>Clear all menus off the bottom of the screen<br>
	[&uarr;Back]
	<li>Screen shot the screen on USB:<br>
	[Save] &rarr; <u>Save</u> &rarr; <u>Format</u> &rarr; 
	<u>24-bit Bit... (*.bmp)</u>
	[Save] &rarr; <u>Save</u> &rarr; <u>Press to Save</u>
</ul>

When complete, you should end-up with an image that looks like the
following.
<br><img src="./img/scope_0.bmp"><br><Br>
</ul>

<ol start=12>
<li>Include the screenshot of the waveforms you just saved as the answer
to this question.  Please place an object about 1 meter away so the answers
provided are consistent.

<li>Using the time per division information from your screeshot capture 
and the duration the waveform (described in divisions), show your 
calculation for the period of the waveform on the echo line by multiplying 
the time division setting by the number of division of the echo pulse.
For example, if your oscilloscope was set to 20ms/division and the 
waveform had a duration of 4.6 divisions, then your answer would look 
like:
<pre>
Oscilloscope set to 20ms/division
The duration of the waveform is 4.6 divisions

	  20ms        
	-------- *  4.6 divisions = 92ms
	division 
</pre>

<li>Modify the convertEchoToCm function using your conversion math
from a previous answer.  Show the complete function as your answer.

<li>Complete the table below by placing a hard reflective object at the
distance given in the "Actual distance" column.  Follow the following
instructions to complete the remaining columns in the table.
<ul>
<li>Measure the duration of the echo pulse (in timer counts using the "s") 
and enter it into the "Echo duration" column below.
<li>Use your answer to questions above to convert the Echo counts 
into distances (in cm).  For each echo count, enter the corresponding 
distance (to 3 significant figures) into the "Calculated distance" column below. 
<li>For each row in the table below, compute the % error between the 
actual distance of the object and calculated distance in the "Calculated
distance (cm)" column and enter it in the "% error" column.
<li>Finally record the distance reported by the convertEchoToCm function
statement in the column "convertEchoToCm".
</ul>

<table class="table table-striped table-bordered table-condensed">
<tr><td>Actual distance	<td>Echo duration (counts)
	<td>Calculated distance (cm)<td>% error 
	<td>convertEchoToCm distance
<tr><td>10 cm	<td>&nbsp	<td>&nbsp	<td>&nbsp	<td>&nbsp
<tr><td>20 cm	<td>&nbsp	<td>&nbsp	<td>&nbsp	<td>&nbsp
<tr><td>30 cm	<td>&nbsp	<td>&nbsp	<td>&nbsp	<td>&nbsp
<tr><td>40 cm	<td>&nbsp	<td>&nbsp	<td>&nbsp	<td>&nbsp
<tr><td>50 cm	<td>&nbsp	<td>&nbsp	<td>&nbsp	<td>&nbsp
</table>

</ol>

</body>
</html>
